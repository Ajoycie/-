<!DOCTYPE html>
    <html lang="zh-CN">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>æ—¥å¸¸ä»»åŠ¡æ‰­è›‹æœº</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <link rel="icon" href="folder blue.ico" type="image/x-icon">
      <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
      <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#3AB4F2',
                secondary: '#a2d2ff',
                common: '#CCCCCC',
                rare: '#4E9F3D',
                epic: '#3AB4F2',
                legendary: '#FF9F4A',
                mythic: '#FF5757',
              },
              fontFamily: {
                sans: ['Inter', 'system-ui', 'sans-serif'],
                yuan: ['"å¹¼åœ†"', 'cursive'], 
                art:['Freestyle Script', 'cursive'],
                art2:['Ink Free', 'cursive'],
              },
            },
          }
        }
      </script>
      <style type="text/tailwindcss">
        @layer utilities {
          .content-auto {
            content-visibility: auto;
          }
          .gacha-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
          }
          .gacha-result-appear {
            animation: fadeIn 0.5s ease-in-out;
          }
          @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
          }
          @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
          }
        }
      </style>
    </head>
    <body class="bg-gray-50 min-h-screen font-sans">
      <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- å¤´éƒ¨ -->
        <header class="mb-8 text-center">
          <h1 class="flex justify-center items-center gap-2 mb-2 font-yuan text-[clamp(1.5rem,3vw,2.5rem)] font-bold">
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">
              æ—¥å¸¸ä»»åŠ¡æ‰­è›‹æœº
            </span>
            <span class="text">ğŸ§Š</span>
          </h1>
          <span style="font-size: 24px; color: #476be1;">
            <p class="font-art2">Nice to meet you, wish you a good day!</p>
          </span>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="bg-white rounded-2xl shadow-lg p-6 mb-8">
          <!-- æ‰­è›‹æœº -->
          <div id="gacha-machine" class="relative mb-8 bg-gradient-to-br from-primary/10 to-primary/5 rounded-xl p-8 text-center">
            <div class="flex flex-col items-center">
              <div class="w-32 h-32 bg-primary/20 rounded-full flex items-center justify-center mb-4 overflow-hidden">
                <div id="gacha-output" class="relative w-full h-full">
                  <div id="gacha-placeholder" class="absolute inset-0 flex items-center justify-center">
                    <i class="fa fa-gift text-primary text-4xl"></i>
                  </div>
                  <div id="gacha-loading" class="absolute inset-0 flex items-center justify-center hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
                  </div>
                </div>
              </div>
              
              <div class="flex flex-wrap justify-center gap-4 mt-4">
                <div class="flex items-center bg-gray-100 rounded-lg px-3 py-2">
                  <i class="fa fa-coins text-primary mr-2"></i>
                  <span id="coin-count" class="font-bold">0</span> ä¸ªæ‰­è›‹å¸
                </div>
                <div class="flex items-center bg-gray-100 rounded-lg px-3 py-2">
                  <i class="fa fa-history text-primary mr-2"></i>
                  <span id="draw-count" class="font-bold">0</span> æ¬¡æŠ½å¥–
                </div>
                <div class="flex items-center bg-gray-100 rounded-lg px-3 py-2">
                  <i class="fa fa-clock-o text-primary mr-2"></i>
                  <span id="pity-count" class="font-bold">0</span> æ¬¡ä¿åº•è®¡æ•°
                </div>
              </div>
              
              <div class="w-full mt-3 bg-gray-200 rounded-full h-2.5">
                <div id="pity-progress" class="bg-primary h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
              
              <button id="draw-button" class="mt-6 bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                <i class="fa fa-refresh mr-2"></i>æŠ½å¥–
              </button>
            </div>
          </div>

          <!-- å†å²è®°å½• -->
          <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æŠ½å–å†å²</h2>
            <div id="history-container" class="space-y-3">
              <div class="text-gray-400 italic text-center py-4">
                æš‚æ— æŠ½å–è®°å½•
              </div>
            </div>
          </div>

          <!-- ç®¡ç†æ§åˆ¶åŒº -->
          <div class="flex flex-wrap justify-center gap-3 mt-8">
            <button id="set-coins-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-all duration-300">
              <i class="fa fa-coins mr-1"></i>è®¾ç½®æ‰­è›‹å¸
            </button>
            <button id="reset-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-all duration-300">
              <i class="fa fa-refresh mr-1"></i>é‡ç½®è®°å½•
            </button>
            <button id="add-reward-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-all duration-300">
              <i class="fa fa-plus-circle mr-1"></i>æ·»åŠ ä»»åŠ¡
            </button>
            <button id="manage-rewards-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-all duration-300">
              <i class="fa fa-cog mr-1"></i>ç®¡ç†åˆ—è¡¨
            </button>
          </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="text-center text-gray-500 text-sm">
          <p class="font-art text-3xl" style= color:#6a7aab>If you are not fortunate, don't assume life is against you.</p>
        </footer>
      </div>

      <!-- ç»“æœæ¨¡æ€æ¡† -->
      <div id="result-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div id="modal-content" class="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full mx-4 scale-95 opacity-0 transition-all duration-300">
          <div class="text-center">
            <div id="result-rarity-icon" class="inline-block mb-4 p-5 rounded-full"></div>
            <h3 id="result-title" class="text-2xl font-bold mb-4"></h3>
            <p id="result-text" class="text-gray-600 text-lg mb-6"></p>
            <button id="close-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full transition-all duration-300">
              å…³é—­
            </button>
          </div>
        </div>
      </div>

      <!-- è®¾ç½®æ‰­è›‹å¸æ¨¡æ€æ¡† -->
      <div id="set-coins-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full mx-4">
          <h3 class="text-xl font-bold text-primary mb-4">è®¾ç½®æ‰­è›‹å¸</h3>
          <input type="number" id="coin-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300 mb-4" placeholder="è¾“å…¥æ‰­è›‹å¸æ•°é‡">
          <div class="flex justify-end gap-3">
            <button id="cancel-set-coins" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full transition-all duration-300">
              å–æ¶ˆ
            </button>
            <button id="confirm-set-coins" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300">
              ç¡®è®¤
            </button>
          </div>
        </div>
      </div>

      <!-- é‡ç½®æ‰€æœ‰è®°å½•æ¨¡æ€æ¡† -->
      <div id="reset-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full mx-4">
          <h3 class="text-xl font-bold text-primary mb-4">é‡ç½®æ‰€æœ‰è®°å½•</h3>
          <p class="text-gray-600 mb-6">ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®°å½•å—ï¼Ÿè¿™å°†æ¸…é™¤ä½ çš„æŠ½å¥–å†å²å’Œè®¾ç½®ã€‚</p>
          <div class="flex justify-end gap-3">
            <button id="cancel-reset" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full transition-all duration-300">
              å–æ¶ˆ
            </button>
            <button id="confirm-reset" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full transition-all duration-300">
              ç¡®è®¤é‡ç½®
            </button>
          </div>
        </div>
      </div>

      <!-- æ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡† -->
      <div id="add-reward-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full mx-4">
          <h3 class="text-xl font-bold text-primary mb-4">æ·»åŠ ä»»åŠ¡</h3>
          <input type="text" id="reward-text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300 mb-4" placeholder="ä»»åŠ¡æè¿°">
          <select id="reward-rarity" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300 mb-4">
            <option value="common">å¸¸è§ (49%)</option>
            <option value="rare">ç¨€æœ‰ (36%)</option>
            <option value="epic">å¥‡ç (12%)</option>
            <option value="legendary">ç¨€ä¸– (2.2%)</option>
            <option value="mythic">è™šå¦„ (0.8%)</option>
          </select>
          <input type="number" id="reward-weight" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300 mb-4" placeholder="æƒé‡" value="49">
          <div class="flex justify-end gap-3">
            <button id="cancel-add-reward" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full transition-all duration-300">
              å–æ¶ˆ
            </button>
            <button id="confirm-add-reward" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full transition-all duration-300">
              æ·»åŠ ä»»åŠ¡
            </button>
          </div>
        </div>
      </div>

      <!-- ç®¡ç†ä»»åŠ¡æ¨¡æ€æ¡† -->
      <div id="manage-rewards-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
          <h3 class="text-xl font-bold text-primary mb-4">ç®¡ç†ä»»åŠ¡</h3>
          <p class="text-gray-600 mb-6">åœ¨è¿™é‡Œå¯ä»¥æŸ¥çœ‹ã€ç¼–è¾‘å’Œåˆ é™¤ç°æœ‰çš„ä»»åŠ¡ã€‚</p>

          <div id="rewards-list" class="space-y-3 mb-6">
            <!-- ä»»åŠ¡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>

          <div class="flex justify-end gap-3">
            <button id="close-manage-rewards" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full transition-all duration-300">
              å…³é—­
            </button>
            <button id="sync-rewards" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-full transition-all duration-300">
              åŒæ­¥é»˜è®¤ä»»åŠ¡åº“
            </button>
          </div>
        </div>
      </div>

      <!-- éŸ³é¢‘å…ƒç´  -->
      <audio id="gacha-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-metallic-game-notification-216.mp3" type="audio/mpeg">
      </audio>

      <script>
        // åˆå§‹ä»»åŠ¡é…ç½®
        const initialTasks = [
          // å¸¸è§ (49%)
          { text: "é¢å¤–èƒŒåŠå°æ—¶å•è¯", rarity: "common" },
          { text: "é¢å¤–å¬åŠå°æ—¶è‹±è¯­å¬åŠ›", rarity: "common" },

          // ç¨€æœ‰ (36%)
          { text: "çœ‹ä¸€ä¼šå„¿è‹±è¯­å…­çº§çœŸé¢˜", rarity: "rare" },
          { text: "å­¦åŠå°æ—¶çº¿æ€§ä»£æ•°", rarity: "rare" },

          // å¥‡ç (12%)
          { text: "å­¦ä¸€å°æ—¶é«˜ç­‰æ•°å­¦", rarity: "epic" },
          { text: "å­¦ä¸€ä¼šå„¿ç¼–ç¨‹", rarity: "epic" },

          // ç¨€ä¸– (2.2%)
          { text: "è¯»ä¸€ä¼šå„¿ä¹¦å§", rarity: "legendary" },
  
          // è™šå¦„ (0.8%)
          { text: "è·‘æ­¥", rarity: "mythic" }
        ];

        // ä» localStorage åŠ è½½æ•°æ®
        function loadData() {
          try {
            const savedGameState = localStorage.getItem('taskGameState');
            const savedTasks = localStorage.getItem('taskList');
            const savedHistory = localStorage.getItem('taskGachaHistory');

            if (savedGameState) {
              taskGameState = JSON.parse(savedGameState);
            }

            if (savedTasks) {
              taskList = JSON.parse(savedTasks);
            } else {
              taskList = [...initialTasks];
            }

            if (savedHistory) {
              taskHistoryData = JSON.parse(savedHistory);
              loadHistory();
            }
          } catch (error) {
            console.error('Failed to load data from localStorage:', error);
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
            taskGameState = {
              coins: 0,
              totalDraws: 0,
              pityCount: 0
            };
            taskList = [...initialTasks];
          }
        }

        // ä¿å­˜æ•°æ®åˆ° localStorage
        function saveData() {
          try {
            localStorage.setItem('taskGameState', JSON.stringify(taskGameState));
            localStorage.setItem('taskList', JSON.stringify(taskList));
            localStorage.setItem('taskGachaHistory', JSON.stringify(taskHistoryData));
          } catch (error) {
            console.error('Failed to save data to localStorage:', error);
            // å¯ä»¥æ·»åŠ å¤‡é€‰å­˜å‚¨æ–¹æ¡ˆæˆ–æç¤ºç”¨æˆ·
          }
        }

        // ä»»åŠ¡é…ç½®
        let taskList = [];

        // æŠ½å–å†å²æ•°æ®
        let taskHistoryData = [];

        // ç¨€æœ‰åº¦é…ç½®
        const rarityConfig = {
          common: {
            name: "å¸¸è§",
            color: "common",
            icon: "fa-circle",
            imageId: 1005,
            weight: 49
          },
          rare: {
            name: "ç¨€æœ‰",
            color: "rare",
            icon: "fa-star",
            imageId: 1011,
            weight: 36
          },
          epic: {
            name: "å¥‡ç",
            color: "epic",
            icon: "fa-diamond",
            imageId: 1015,
            weight: 12
          },
          legendary: {
            name: "ç¨€ä¸–",
            color: "legendary",
            icon: "fa-fire",
            imageId: 1019,
            weight: 2.2
          },
          mythic: {
            name: "è™šå¦„",
            color: "mythic",
            icon: "fa-star-o",
            imageId: 1025,
            weight: 0.8
          }
        };

        // æ¸¸æˆçŠ¶æ€
        let taskGameState = {
          coins: 0,
          totalDraws: 0,
          pityCount: 0
        };

        // DOM å…ƒç´ 
        const drawButton = document.getElementById('draw-button');
        const coinCount = document.getElementById('coin-count');
        const drawCount = document.getElementById('draw-count');
        const pityCount = document.getElementById('pity-count');
        const pityProgress = document.getElementById('pity-progress');
        const historyContainer = document.getElementById('history-container');
        const resultModal = document.getElementById('result-modal');
        const modalContent = document.getElementById('modal-content');
        const resultTitle = document.getElementById('result-title');
        const resultText = document.getElementById('result-text');
        const resultRarityIcon = document.getElementById('result-rarity-icon');
        const closeModal = document.getElementById('close-modal');
        const gachaMachine = document.getElementById('gacha-machine');
        const gachaOutput = document.getElementById('gacha-output');
        const gachaPlaceholder = document.getElementById('gacha-placeholder');
        const gachaLoading = document.getElementById('gacha-loading');
        const gachaSound = document.getElementById('gacha-sound');

        // ç®¡ç†æ§åˆ¶æŒ‰é’®
        const setCoinsBtn = document.getElementById('set-coins-btn');
        const resetBtn = document.getElementById('reset-btn');
        const addRewardBtn = document.getElementById('add-reward-btn');
        const manageRewardsBtn = document.getElementById('manage-rewards-btn');
        const syncRewardsBtn = document.getElementById('sync-rewards');

        // æ¨¡æ€æ¡†å…ƒç´ 
        const setCoinsModal = document.getElementById('set-coins-modal');
        const coinInput = document.getElementById('coin-input');
        const cancelSetCoins = document.getElementById('cancel-set-coins');
        const confirmSetCoins = document.getElementById('confirm-set-coins');

        const resetModal = document.getElementById('reset-modal');
        const cancelReset = document.getElementById('cancel-reset');
        const confirmReset = document.getElementById('confirm-reset');

        const addRewardModal = document.getElementById('add-reward-modal');
        const rewardText = document.getElementById('reward-text');
        const rewardRarity = document.getElementById('reward-rarity');
        const rewardWeight = document.getElementById('reward-weight');
        const cancelAddReward = document.getElementById('cancel-add-reward');
        const confirmAddReward = document.getElementById('confirm-add-reward');

        const manageRewardsModal = document.getElementById('manage-rewards-modal');
        const rewardsList = document.getElementById('rewards-list');
        const closeManageRewards = document.getElementById('close-manage-rewards');

        // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
        function updateGameState() {
          coinCount.textContent = taskGameState.coins;
          drawCount.textContent = taskGameState.totalDraws;
          pityCount.textContent = taskGameState.pityCount;
          pityProgress.style.width = `${(taskGameState.pityCount / 20) * 100}%`;

          // ç¦ç”¨æŒ‰é’®å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç¡¬å¸
          if (taskGameState.coins <= 0) {
            drawButton.disabled = true;
            drawButton.classList.add('opacity-50', 'cursor-not-allowed');
          } else {
            drawButton.disabled = false;
            drawButton.classList.remove('opacity-50', 'cursor-not-allowed');
          }
          saveData(); // ä¿å­˜æ•°æ®
        }

        // æ·»åŠ å†å²è®°å½•
        function addHistory(reward) {
          const rarity = rarityConfig[reward.rarity];
          const rarityColor = rarity.color;
          
          const historyItem = document.createElement('div');
          historyItem.className = 'bg-gray-50 rounded-lg p-4 flex items-center justify-between gacha-result-appear';
          historyItem.innerHTML = `
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-full bg-${rarityColor}/20 flex items-center justify-center mr-4">
                <i class="fa ${rarity.icon} text-${rarityColor} text-xl"></i>
              </div>
              <div class="flex-grow">
                <div class="font-bold text-lg text-${rarityColor}">${rarity.name}</div>
                <div class="text-gray-600">${reward.text}</div>
              </div>
            </div>
            <button class="delete-history bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-full text-sm transition-all duration-300" data-index="${taskHistoryData.length}">
              <i class="fa fa-trash-o mr-1"></i>åˆ é™¤
            </button>
          `;

          // å¦‚æœæ˜¯ç¬¬ä¸€æ¡è®°å½•ï¼Œæ¸…ç©ºæç¤ºæ–‡æœ¬
          if (historyContainer.querySelector('.text-gray-400')) {
            historyContainer.innerHTML = '';
          }

          historyContainer.insertBefore(historyItem, historyContainer.firstChild);

          // å°†æ–°çš„ä»»åŠ¡æ·»åŠ åˆ°å†å²æ•°æ®ä¸­
          taskHistoryData.push(reward);
          // å°†å†å²æ•°æ®å­˜å‚¨åˆ° localStorage ä¸­
          saveData();

          // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
          historyItem.querySelector('.delete-history').addEventListener('click', (e) => {
            const index = parseInt(e.currentTarget.dataset.index);
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå†å²è®°å½•å—ï¼Ÿ')) {
              taskHistoryData.splice(index, 1);
              loadHistory();
              saveData();
            }
          });
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
          if (taskHistoryData.length === 0) {
            historyContainer.innerHTML = `
              <div class="text-gray-400 italic text-center py-4">
                æš‚æ— æŠ½å–è®°å½•
              </div>
            `;
            return;
          }

          // æ¸…ç©ºç°æœ‰å†å²è®°å½•
          historyContainer.innerHTML = '';

          // æ·»åŠ æ‰€æœ‰å†å²è®°å½•
          taskHistoryData.forEach((reward, index) => {
            const rarity = rarityConfig[reward.rarity];
            const rarityColor = rarity.color;

            const historyItem = document.createElement('div');
            historyItem.className = 'bg-gray-50 rounded-lg p-4 flex items-center justify-between';
            historyItem.innerHTML = `
              <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-${rarityColor}/20 flex items-center justify-center mr-4">
                  <i class="fa ${rarity.icon} text-${rarityColor} text-xl"></i>
                </div>
                <div class="flex-grow">
                  <div class="font-bold text-lg text-${rarityColor}">${rarity.name}</div>
                  <div class="text-gray-600">${reward.text}</div>
                </div>
              </div>
              <button class="delete-history bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-full text-sm transition-all duration-300" data-index="${index}">
                <i class="fa fa-trash-o mr-1"></i>åˆ é™¤
              </button>
            `;

            historyContainer.appendChild(historyItem);

            // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
            historyItem.querySelector('.delete-history').addEventListener('click', (e) => {
              const index = parseInt(e.currentTarget.dataset.index);
              if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå†å²è®°å½•å—ï¼Ÿ')) {
                taskHistoryData.splice(index, 1);
                loadHistory();
                saveData();
              }
            });
          });
        }

        // éšæœºæŠ½å–ä»»åŠ¡
        function drawReward() {
          // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç¡¬å¸
          if (taskGameState.coins <= 0) {
            alert('ä½ çš„æ‰­è›‹å¸ä¸è¶³ï¼');
            return;
          }

          // æ’­æ”¾éŸ³æ•ˆ
          gachaSound.currentTime = 0;
          gachaSound.play().catch(e => console.log('æ— æ³•æ’­æ”¾éŸ³æ•ˆ:', e));

          // å‡å°‘ç¡¬å¸
          taskGameState.coins--;

          // å¢åŠ æ€»æŠ½å–æ¬¡æ•°å’Œä¿åº•è®¡æ•°
          taskGameState.totalDraws++;
          taskGameState.pityCount++;

          // æ›´æ–°æ˜¾ç¤º
          updateGameState();

          // æ‘‡åŠ¨æœºå™¨
          gachaMachine.classList.add('gacha-shake');

          // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
          gachaPlaceholder.classList.add('hidden');
          gachaLoading.classList.remove('hidden');

          // ç¦ç”¨æŒ‰é’®
          drawButton.disabled = true;
          drawButton.classList.add('opacity-50', 'cursor-not-allowed');

          // 2ç§’åæ˜¾ç¤ºç»“æœ
          setTimeout(() => {
            let reward;

            // æ£€æŸ¥æ˜¯å¦è§¦å‘ä¿åº•
            if (taskGameState.pityCount >= 20) {
              // ä¿åº•è·å¾—è™šå¦„å“è´¨
              const mythicTasks = taskList.filter(r => r.rarity === 'mythic');
              if (mythicTasks.length === 0) {
                // å¦‚æœæ²¡æœ‰è™šå¦„å“è´¨ï¼Œä¿åº•è·å¾—ç¨€ä¸–å“è´¨
                const legendaryTasks = taskList.filter(r => r.rarity === 'legendary');
                if (legendaryTasks.length === 0) {
                  // å¦‚æœæ²¡æœ‰ç¨€ä¸–å“è´¨ï¼Œä¿åº•è·å¾—å¥‡çå“è´¨ï¼Œä»¥æ­¤ç±»æ¨
                  const epicTasks = taskList.filter(r => r.rarity === 'epic');
                  if (epicTasks.length === 0) {
                    const rareTasks = taskList.filter(r => r.rarity === 'rare');
                    reward = rareTasks[Math.floor(Math.random() * rareTasks.length)];
                  } else {
                    reward = epicTasks[Math.floor(Math.random() * epicTasks.length)];
                  }
                } else {
                  reward = legendaryTasks[Math.floor(Math.random() * legendaryTasks.length)];
                }
              } else {
                const randomIndex = Math.floor(Math.random() * mythicTasks.length);
                reward = mythicTasks[randomIndex];
              }
              taskGameState.pityCount = 0;
            } else {
              // å…ˆæŠ½å–å“çº§
              const totalWeight = Object.values(rarityConfig).reduce((sum, r) => sum + r.weight, 0);
              let random = Math.random() * totalWeight;
              let selectedRarity;

              for (const [rarity, config] of Object.entries(rarityConfig)) {
                random -= config.weight;
                if (random <= 0) {
                  selectedRarity = rarity;
                  break;
                }
              }

              // ä»è¯¥å“çº§ä¸­éšæœºæŠ½å–ä»»åŠ¡
              const filteredTasks = taskList.filter(r => r.rarity === selectedRarity);
              if (filteredTasks.length === 0) {
                // å¦‚æœè¯¥å“çº§æ²¡æœ‰ä»»åŠ¡ï¼Œé€’å½’é‡æ–°æŠ½å–
                return drawReward();
              }
              const randomIndex = Math.floor(Math.random() * filteredTasks.length);
              reward = filteredTasks[randomIndex];
            }

            // æ˜¾ç¤ºç»“æœ
            showResult(reward);

            // æ·»åŠ åˆ°å†å²è®°å½•
            addHistory(reward);

            // é‡ç½®åŠ¨ç”»å’ŒUI
            gachaMachine.classList.remove('gacha-shake');
            gachaLoading.classList.add('hidden');
            gachaPlaceholder.classList.remove('hidden');

            // å¯ç”¨æŒ‰é’®
            drawButton.disabled = false;
            drawButton.classList.remove('opacity-50', 'cursor-not-allowed');
          }, 2000);
        }

        // æ˜¾ç¤ºä»»åŠ¡ç»“æœ
        function showResult(reward) {
          const rarity = rarityConfig[reward.rarity];
          const rarityColor = rarity.color;

          // è®¾ç½®ç»“æœå†…å®¹
          resultTitle.textContent = `æ­å–œè·å¾— ${rarity.name} ä»»åŠ¡ï¼`;
          resultText.textContent = reward.text;

          // è®¾ç½®ç¨€æœ‰åº¦å›¾æ ‡å’Œé¢œè‰²
          resultRarityIcon.className = `inline-block mb-4 p-5 rounded-full bg-${rarityColor}/20`;
          resultRarityIcon.innerHTML = `<i class="fa ${rarity.icon} text-${rarityColor} text-5xl"></i>`;

          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          resultModal.classList.remove('hidden');

          // æ·»åŠ åŠ¨ç”»
          setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
          }, 10);
        }

        // å…³é—­æ¨¡æ€æ¡†
        function hideResultModal() {
          modalContent.classList.remove('scale-100', 'opacity-100');
          modalContent.classList.add('scale-95', 'opacity-0');

          setTimeout(() => {
            resultModal.classList.add('hidden');
          }, 300);
        }

        // è®¾ç½®æ‰­è›‹å¸
        function openSetCoinsModal() {
          coinInput.value = taskGameState.coins;
          setCoinsModal.classList.remove('hidden');
          coinInput.focus();
        }

        function closeSetCoinsModal() {
          setCoinsModal.classList.add('hidden');
        }

        function confirmSetCoinsHandler() {
          const coins = parseInt(coinInput.value);
          if (!isNaN(coins) && coins >= 0) {
            taskGameState.coins = coins;
            updateGameState();
            closeSetCoinsModal();
          } else {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼');
          }
        }

        // é‡ç½®æ‰€æœ‰è®°å½•
        function openResetModal() {
          resetModal.classList.remove('hidden');
        }

        function closeResetModal() {
          resetModal.classList.add('hidden');
        }

        function confirmResetHandler() {
          if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®°å½•å—ï¼Ÿè¿™å°†æ¸…é™¤ä½ çš„æŠ½å¥–å†å²å’Œè®¾ç½®ã€‚')) {
            taskGameState = {
              coins: 0,
              totalDraws: 0,
              pityCount: 0
            };

            taskHistoryData = [];
            historyContainer.innerHTML = `
              <div class="text-gray-400 italic text-center py-4">
                æš‚æ— æŠ½å–è®°å½•
              </div>
            `;

            updateGameState();
            closeResetModal();
          }
        }

        // æ·»åŠ æ–°ä»»åŠ¡
        function openAddRewardModal() {
          rewardText.value = '';
          rewardRarity.value = 'common';
          rewardWeight.value = rarityConfig.common.weight;
          addRewardModal.classList.remove('hidden');
          rewardText.focus();
        }

        rewardRarity.addEventListener('change', () => {
          const selectedRarity = rewardRarity.value;
          rewardWeight.value = rarityConfig[selectedRarity].weight;
        });

        function closeAddRewardModal() {
          addRewardModal.classList.add('hidden');
        }

        function confirmAddRewardHandler() {
          const text = rewardText.value.trim();
          const rarity = rewardRarity.value;
          const weight = parseFloat(rewardWeight.value);

          if (text && !isNaN(weight) && weight > 0) {
            rarityConfig[rarity].weight = weight;
            taskList.push({ text, rarity });
            closeAddRewardModal();
            alert('ä»»åŠ¡å·²æ·»åŠ åˆ°ä»»åŠ¡åº“ï¼');
            saveData(); // ä¿å­˜æ•°æ®
          } else {
            alert('è¯·å¡«å†™æœ‰æ•ˆçš„ä»»åŠ¡ä¿¡æ¯å’Œæƒé‡ï¼');
          }
        }

        // ç®¡ç†ä»»åŠ¡
        function openManageRewardsModal() {
          renderRewardsList();
          manageRewardsModal.classList.remove('hidden');
        }

        function closeManageRewardsModal() {
          manageRewardsModal.classList.add('hidden');
        }

        function renderRewardsList() {
          rewardsList.innerHTML = '';

          if (taskList.length === 0) {
            rewardsList.innerHTML = `
              <div class="text-gray-400 italic text-center py-4">
                ä»»åŠ¡åº“ä¸ºç©ºï¼Œè¯·æ·»åŠ ä»»åŠ¡
              </div>
            `;
            return;
          }

          taskList.forEach((reward, index) => {
            const rarity = rarityConfig[reward.rarity];
            const rarityColor = rarity.color;

            const rewardItem = document.createElement('div');
            rewardItem.className = 'bg-gray-50 rounded-lg p-4 flex items-center justify-between';
            rewardItem.innerHTML = `
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-${rarityColor}/20 flex items-center justify-center mr-3">
                  <i class="fa ${rarity.icon} text-${rarityColor}"></i>
                </div>
                <div>
                  <div class="font-medium text-${rarityColor}">${rarity.name}</div>
                  <div class="text-sm text-gray-600">${reward.text}</div>
                </div>
              </div>
              <button class="delete-reward bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-full text-sm transition-all duration-300" data-index="${index}">
                <i class="fa fa-trash-o mr-1"></i>åˆ é™¤
              </button>
            `;

            rewardsList.appendChild(rewardItem);
          });

          // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
          document.querySelectorAll('.delete-reward').forEach(button => {
            button.addEventListener('click', (e) => {
              const index = parseInt(e.currentTarget.dataset.index);
              if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                taskList.splice(index, 1);
                renderRewardsList();
                saveData(); // ä¿å­˜æ•°æ®
              }
            });
          });
        }

        // åŒæ­¥é»˜è®¤ä»»åŠ¡åº“
        function syncDefaultRewards() {
          if (confirm('ç¡®å®šè¦åŒæ­¥é»˜è®¤ä»»åŠ¡åº“å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰ä»»åŠ¡è®¾ç½®ã€‚')) {
            taskList = [...initialTasks];
            for (const [rarity, config] of Object.entries(rarityConfig)) {
              if (rarity === 'common') config.weight = 49;
              if (rarity === 'rare') config.weight = 36;
              if (rarity === 'epic') config.weight = 12;
              if (rarity === 'legendary') config.weight = 2.2;
              if (rarity === 'mythic') config.weight = 0.8;
            }
            renderRewardsList();
            saveData();
            alert('ä»»åŠ¡åº“å·²åŒæ­¥åˆ°é»˜è®¤æ¨¡æ¿ï¼');
          }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
          // åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®
          loadData();

          // æ›´æ–°æ¸¸æˆçŠ¶æ€
          updateGameState();

          // è®¾ç½®äº‹ä»¶ç›‘å¬
          drawButton.addEventListener('click', drawReward);
          closeModal.addEventListener('click', hideResultModal);
          resultModal.addEventListener('click', (e) => {
            if (e.target === resultModal) {
              hideResultModal();
            }
          });

          // ç®¡ç†æ§åˆ¶æŒ‰é’®äº‹ä»¶
          setCoinsBtn.addEventListener('click', openSetCoinsModal);
          resetBtn.addEventListener('click', openResetModal);
          addRewardBtn.addEventListener('click', openAddRewardModal);
          manageRewardsBtn.addEventListener('click', openManageRewardsModal);
          syncRewardsBtn.addEventListener('click', syncDefaultRewards);

          // è®¾ç½®ç¡¬å¸æ¨¡æ€æ¡†äº‹ä»¶
          cancelSetCoins.addEventListener('click', closeSetCoinsModal);
          confirmSetCoins.addEventListener('click', confirmSetCoinsHandler);

          // é‡ç½®æ¨¡æ€æ¡†äº‹ä»¶
          cancelReset.addEventListener('click', closeResetModal);
          confirmReset.addEventListener('click', confirmResetHandler);

          // æ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†äº‹ä»¶
          cancelAddReward.addEventListener('click', closeAddRewardModal);
          confirmAddReward.addEventListener('click', confirmAddRewardHandler);

          // ç®¡ç†ä»»åŠ¡æ¨¡æ€æ¡†äº‹ä»¶
          closeManageRewards.addEventListener('click', closeManageRewardsModal);
          manageRewardsModal.addEventListener('click', (e) => {
            if (e.target === manageRewardsModal) {
              closeManageRewardsModal();
            }
          });
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
      </script>
    </body>
    </html>
